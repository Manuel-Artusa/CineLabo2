CREATE PROCEDURE SP_CONSULTAR_PELICULAS_DETALLADO
AS
BEGIN
    SELECT
        P.id_pelicula,
        P.Titulo,
        P.duracion,
        G.id_genero,
        G.DESCRIPCION,
        C.id_clasificacion,
        C.Descripcion AS DescripcionClasificacion,
        I.id_idioma,
        I.IDIOMA,
        P.Fec_Estreno
    FROM
        Peliculas P
    JOIN
        Genero G ON P.id_genero = G.id_genero
    JOIN
        Clasificacion C ON P.id_clasificacion = C.id_clasificacion
    JOIN
        Idiomas I ON P.id_idioma = I.id_idioma;
END;
SELECT * FROM PELICULAS


CREATE PROCEDURE SP_CONSULTAR_PELICULAS_DETALLADO2
AS
BEGIN
    SELECT
        P.ID_PELICULA,
        P.TITULO,
        P.DURACION,
        G.ID_GENERO,
        G.DESCRIPCION AS NombreGenero,
        C.ID_CLASIFICACION,
        C.DESCRIPCION AS DescripcionClasificacion,
        I.ID_IDIOMA,
        I.IDIOMA AS Lenguaje,
        P.FEC_ESTRENO,
        PO.ID_PAIS_ORIGEN,
        PO.PAIS AS Pais
    FROM
        PELICULAS P
    INNER JOIN
        GENERO G ON P.ID_GENERO = G.ID_GENERO
    INNER JOIN
        CLASIFICACION C ON P.ID_CLASIFICACION = C.ID_CLASIFICACION
    INNER JOIN
        IDIOMAS I ON P.ID_IDIOMA = I.ID_IDIOMA
    INNER JOIN
        PAIS_ORIGEN PO ON P.ID_PAIS_ORIGEN = PO.ID_PAIS_ORIGEN
END

select * from PELICULAS



CREATE PROCEDURE SP_OBTENER_GENEROS
AS
BEGIN
    -- Obtener g√©neros
    SELECT ID_GENERO, DESCRIPCION
    FROM GENERO;
END

CREATE PROCEDURE SP_OBTENER_CLIENTES_DETALLADO
AS
BEGIN
    SELECT
        C.ID_CLIENTE,
        C.NOMBRE_CLIENTE,
        C.APELLIDO_CLIENTE,
        T.ID_TIPO_DOC,
        T.DESCRIPCION AS TIPO_DOCUMENTO,
        C.DOCUMENTO,
        C.TELEFONO,
        C.EMAIL
    FROM
        CLIENTES C
        INNER JOIN TIPOS_DOC T ON C.ID_TIPO_DOC = T.ID_TIPO_DOC
END

CREATE PROCEDURE SP_CONSULTAR_CLIENTES_CON_TOTAL_GASTADO
AS
BEGIN
    SELECT
        C.ID_CLIENTE,
        C.NOMBRE_CLIENTE,
        C.APELLIDO_CLIENTE,
        T.ID_TIPO_DOC,
        T.DESCRIPCION AS TIPO_DOCUMENTO,
        C.DOCUMENTO,
        C.TELEFONO,
        C.EMAIL,
        ISNULL(SUM(DC.PRECIO), 0) AS TOTAL_GASTADO
    FROM
        CLIENTES C
        INNER JOIN TIPOS_DOC T ON C.ID_TIPO_DOC = T.ID_TIPO_DOC
        LEFT JOIN COMPROBANTES CMP ON C.ID_CLIENTE = CMP.ID_CLIENTE
        LEFT JOIN DETALLES_COMPROBANTES DC ON CMP.ID_COMPROBANTE = DC.ID_COMPROBANTE
    GROUP BY
        C.ID_CLIENTE, C.NOMBRE_CLIENTE, C.APELLIDO_CLIENTE, T.ID_TIPO_DOC, T.DESCRIPCION, C.DOCUMENTO, C.TELEFONO, C.EMAIL
END

CREATE PROCEDURE SP_CONSULTAR_CLIENTES_POR_GENERO_PUNTAJE
    @GeneroPelicula VARCHAR(20)
AS
BEGIN
    SELECT
        C.ID_CLIENTE,
        C.NOMBRE_CLIENTE +' '+C.APELLIDO_CLIENTE AS NOMBRE_APELLIDO,
        T.ID_TIPO_DOC,
        T.DESCRIPCION AS TIPO_DOCUMENTO,
        C.DOCUMENTO,
        C.TELEFONO,
        C.EMAIL,
        SUM(DC.PRECIO) AS TotalGastado
    FROM
        CLIENTES C
        INNER JOIN TIPOS_DOC T ON C.ID_TIPO_DOC = T.ID_TIPO_DOC
        LEFT JOIN COMPROBANTES CMP ON C.ID_CLIENTE = CMP.ID_CLIENTE
        LEFT JOIN DETALLES_COMPROBANTES DC ON CMP.ID_COMPROBANTE = DC.ID_COMPROBANTE
        LEFT JOIN FUNCIONES F ON DC.ID_FUNCION = F.ID_FUNCION
        LEFT JOIN PELICULAS P ON F.ID_PELICULA = P.ID_PELICULA
        LEFT JOIN GENERO G ON P.ID_GENERO = G.ID_GENERO
    WHERE
        G.DESCRIPCION = @GeneroPelicula
    GROUP BY
        C.ID_CLIENTE,
        C.NOMBRE_CLIENTE,
        C.APELLIDO_CLIENTE,
        T.ID_TIPO_DOC,
        T.DESCRIPCION,
        C.DOCUMENTO,
        C.TELEFONO,
        C.EMAIL
    ORDER BY
        TotalGastado DESC;
	END;

create PROCEDURE SP_CONSULTAR_TOP3_CLIENTES_POR_GENERO_PUNTAJE
    @GeneroPelicula VARCHAR(20)
AS
BEGIN
    WITH ClientesNumerados AS (
        SELECT
            C.ID_CLIENTE,
            C.NOMBRE_CLIENTE,
            C.APELLIDO_CLIENTE,
            T.ID_TIPO_DOC,
            T.DESCRIPCION AS TIPO_DOCUMENTO,
            C.DOCUMENTO,
            C.TELEFONO,
            C.EMAIL,
            SUM(DC.PRECIO) AS TotalGastado,
            ROW_NUMBER() OVER (ORDER BY SUM(DC.PRECIO) DESC) AS NumeroFila
        FROM
            CLIENTES C
            INNER JOIN TIPOS_DOC T ON C.ID_TIPO_DOC = T.ID_TIPO_DOC
            LEFT JOIN COMPROBANTES CMP ON C.ID_CLIENTE = CMP.ID_CLIENTE
            LEFT JOIN DETALLES_COMPROBANTES DC ON CMP.ID_COMPROBANTE = DC.ID_COMPROBANTE
            LEFT JOIN FUNCIONES F ON DC.ID_FUNCION = F.ID_FUNCION
            LEFT JOIN PELICULAS P ON F.ID_PELICULA = P.ID_PELICULA
            LEFT JOIN GENERO G ON P.ID_GENERO = G.ID_GENERO
        WHERE
            G.DESCRIPCION = @GeneroPelicula
        GROUP BY
            C.ID_CLIENTE,
            C.NOMBRE_CLIENTE,
            C.APELLIDO_CLIENTE,
            T.ID_TIPO_DOC,
            T.DESCRIPCION,
            C.DOCUMENTO,
            C.TELEFONO,
            C.EMAIL
    )
    
    SELECT
        ID_CLIENTE,
        NOMBRE_CLIENTE,
        APELLIDO_CLIENTE,
        TIPO_DOCUMENTO,
        DOCUMENTO,
        TELEFONO,
        EMAIL,
        TotalGastado
    FROM
        ClientesNumerados
    WHERE
        NumeroFila <= 3;
END
